<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>{{title}}</title>

  {% load static %}
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'css/style.css' %}" rel="stylesheet">

</head>

<body>

  <div class="d-flex" id="wrapper">

    <!-- Sidebar -->
    <div class="bg-light border-right" id="sidebar-wrapper">
      <div class="sidebar-heading">Smile Widget</div>
      <div class="list-group list-group-flush">
        <a href="#" class="list-group-item list-group-item-action bg-light">Dashboard</a>
      </div>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">

      <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom" style="padding: 1em">
        <span class="navbar-toggler-icon" id="menu-toggle"></span>
      </nav>

      <div class="container-fluid">
        <div class="product-filter">
            <div class="row">
                <div class="col" id="product-code">
                </div>
                <div class="col">
                    <input type="date" id="product-date" class="form-control"/>
                </div>
                <div class="col" id="product-giftcard">
                </div>
                <div class="col-2">
                    <button class="btn btn-primary" id="product-submit">Check Price</button>
                </div>
            </div>
        </div>
        <div class="product-data">
            <table class="table table-hover" id="productTable">
                <thead>
                    <tr>
                        <th>Product Code</th>
                        <th>Product Name</th>
                        <th>Price</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
      </div>
    </div>
    <!-- /#page-content-wrapper -->

  </div>
  <!-- /#wrapper -->

  <!-- Bootstrap core JavaScript -->
  <script src="{% static 'js/jquery.min.js' %}"></script>
  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

  <!-- Menu Toggle Script -->
  <script>
    $( document ).ready( function() {
        getProductCode();
        getGiftCardCode();
        setDefaultDate();
        poll();
    });

    $(document).on('click', "#product-submit", function() {
        getProductPrice();
    });

    // Fetch Product Code for filter
    function getProductCode() {
        $.ajax({
            type: 'Get',
            url: '/api/getproductcode',
            dataType: "json",
            success: function(data) {
                var myDiv = document.getElementById("product-code");
                var selectList = document.createElement("select");
                selectList.id = "product-code-select";
                selectList.className = "form-control";
                myDiv.appendChild(selectList);

                var option = document.createElement("option");
                option.value = "";
                option.text = "Select a Product";
                selectList.appendChild(option);

                if(data.length !== 0) {
                    data.forEach(element => {
                        var option = document.createElement("option");
                        option.value = element.id;
                        option.text = element.name +"( "+ element.code + ")";
                        selectList.appendChild(option); 
                    });
                }
            }
        });
    }

    // Fetch Gift Card Code for filter
    function getGiftCardCode() {
        $.ajax({
            type: 'Get',
            url: '/api/getgiftcardcode',
            dataType: "json",
            success: function(data) {
                var myDiv = document.getElementById("product-giftcard");
                var selectList = document.createElement("select");
                selectList.id = "product-giftcard-select";
                selectList.className = "form-control";
                myDiv.appendChild(selectList);

                var option = document.createElement("option");
                option.value = "";
                option.text = "Select a Gift Card";
                selectList.appendChild(option);

                if(data.length !== 0) {
                    data.forEach(element => {
                        var option = document.createElement("option");
                        option.value = element.id;
                        option.text = element.code;
                        selectList.appendChild(option); 
                    });
                }
            }
        });
    }

    function setDefaultDate() {
        document.getElementById('product-date').valueAsDate = new Date();
    }

    // Fetch Product Price w.r.t prod_id, date and gift card
    function getProductPrice() {

        //Clear Table
        $("#tbody").empty();

        var product_id = (document.getElementById("product-code-select").value?document.getElementById("product-code-select").value:"All");            
        var product_date = document.getElementById("product-date").value;
        var product_giftcard = (document.getElementById("product-giftcard-select").value?document.getElementById("product-giftcard-select").value:"All");
        $.ajax({
            type: 'Get',
            url: '/api/getproductprice?productid='+product_id+'&date='+product_date+'&giftcode='+product_giftcard,
            dataType: "json",
            success: function(data) {
                if(data.length !== 0) {
                    var table = document.getElementById("tbody");
                    data.forEach(element => {
                        var row = table.insertRow(0);
                        var cell1 = row.insertCell(0);
                        var cell2 = row.insertCell(1);
                        var cell3 = row.insertCell(2);
                        cell1.innerHTML = element.product_code;
                        cell2.innerHTML = element.product_name;
                        cell3.innerHTML = formatMoney(element.amount);
                    });
                }
                console.log(data);
            }
        });
    }

    function formatMoney(amount) {
        return '$' + (amount/100).toFixed(2);
    }

    // Poll till the UI loads the dynamic data
    function poll() {
        setTimeout(function(){ 
            if(document.getElementById("product-code-select")) {
                getProductPrice();
            } else {
                poll();
            }
         }, 1000);
    }

    $("#menu-toggle").click(function(e) {
      e.preventDefault();
      $("#wrapper").toggleClass("toggled");
    });
  </script>

</body>

</html>